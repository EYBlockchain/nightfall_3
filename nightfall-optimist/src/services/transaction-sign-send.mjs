/* eslint-disable no-param-reassign */

import config from 'config';
import { web3 } from '@polygon-nightfall/common-files/utils/contract.mjs';
import { estimateGas, estimateGasPrice } from '@polygon-nightfall/common-files/utils/gas.mjs';
import logger from '@polygon-nightfall/common-files/utils/logger.mjs';
import { Mutex } from 'async-mutex';

const { GAS, GAS_MULTIPLIER, GAS_ESTIMATE_ENDPOINT, GAS_PRICE, GAS_PRICE_MULTIPLIER } = config;

const nonceMutex = new Mutex();

let nonce = 0;

/**
 * Create and sign a web3 transaction (tx) object
 *
 * @async
 * @function createSignedTransaction
 * @param {string} ethPrivateKey Eth private key of the sender to sign the tx
 * @param {string} from Eth address sending the contents of the tx
 * @param {string} to Eth address receiving the contents of the tx
 * @param {string} data The unsigned tx generated by encodeABI
 * @param {number} value Payment for the tx
 * @returns {Promise<SignedTransaction>}
 */
export async function createSignedTransaction(ethPrivateKey, from, to, data, value = 0) {
  // Check if web3 ws is available
  const isListening = await web3.eth.net.isListening();
  if (!isListening) throw new Error('Web3 ws not listening, try again later');

  logger.debug('Create transaction object...');

  let signedTx;
  await nonceMutex.runExclusive(async () => {
    // Update nonce if necessary
    const _nonce = await web3.eth.getTransactionCount(from);
    if (nonce < _nonce) {
      nonce = _nonce;
    }
    // Estimate gasPrice
    const gasPrice = await estimateGasPrice(
      web3,
      GAS_ESTIMATE_ENDPOINT,
      GAS_PRICE,
      GAS_PRICE_MULTIPLIER,
    );
    // Eth tx
    const tx = {
      from,
      to,
      data,
      value,
      gasPrice,
      nonce,
    };
    nonce++;

    // Estimate gas
    const gas = await estimateGas(tx, web3, GAS, GAS_MULTIPLIER);
    tx.gas = gas;

    logger.debug({ msg: 'Sign transaction...', tx });
    signedTx = await web3.eth.accounts.signTransaction(tx, ethPrivateKey);
  });

  return signedTx;
}

/**
 * Send a signed transaction (tx) to the network using web3
 *
 * @async
 * @function sendSignedTransaction
 * @param {TransactionConfig} tx Web3 transaction object
 * @returns {Promise<TransactionReceipt>}
 */
export async function sendSignedTransaction(tx) {
  logger.debug({ msg: 'Send signed transaction...', tx });
  // As per https://web3js.readthedocs.io/en/v1.7.3/web3-eth.html#eth-sendtransaction-return
  return new Promise((resolve, reject) => {
    web3.eth
      .sendSignedTransaction(tx.rawTransaction)
      .then(receipt => resolve(receipt))
      .catch(error => reject(error));
  });
}
