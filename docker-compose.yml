version: '3.5'

services:
  deployer:
    build:
      dockerfile: Dockerfile
      context: .
    volumes:
      - ./contracts/:/app/contracts/
      - ./migrations/:/app/migrations/
      - ./truffle-config.js:/app/truffle-config.js
      - ./circuits/:/app/circuits/
      - build:/app/build/
      - ./src:/app/src/
      - ./config:/app/config/
      - proving_files:/app/proving_files
    depends_on:
      - openethereum
      - zokrates
    environment:
      LOG_LEVEL: silly
      ETH_NETWORK: openethereum
      ALWAYS_DO_TRUSTED_SETUP: 0 # falsey
    networks:
      - midnight_deployer_network

  openethereum:
    image: docker.pkg.github.com/eyblockchain/parity-zvm/openethereum:83947864dfb666444136ee5189a0b0c6ce79f4e5
    volumes:
      - type: volume
        source: chaindata
        target: /root/.local/share/openethereum/
    ports:
      - '8545:8545'
      - '8546:8546'
    networks:
      - midnight_deployer_network
    command: ["--config", "dev-insecure", "--unsafe-expose", "--unlock", "0x00a329c0648769a73afac7f9381e08fb43dbea72", "--password", "./pwd.txt"]

  # The Zokrates Microservice
  # Note that the circuits are bind mounted.  Normally they would be a volume
  # but we can't do a bind mount and a volume in the same place.  This is
  # only an issue for development where we want to mount the local file system
  zokrates:
    image: docker.pkg.github.com/eyblockchain/zokrates-zexe-microservice/zokrates_zexe_microservice:88cadbe8d675a89074c1368f5dd30c104f125545
    command: ./start-script
    depends_on:
      - rabbitmq
    volumes:
      - type: volume
        source: proving_files
        target: /app/output/
      - type: bind
        source: ./circuits/
        target: /app/circuits/
    environment:
      PROVING_SCHEME: 'gm17'
      RABBITMQ_HOST: amqp://rabbitmq
      RABBITMQ_PORT: 5672
      ENABLE_QUEUE: 1
    ports:
      - '8080:80'
    networks:
      - midnight_deployer_network

  rabbitmq:
    image: rabbitmq
    ports:
      - '15674:15674'
    networks:
      - midnight_deployer_network

volumes:
  chaindata:
  proving_files:
  build:

networks:
  midnight_deployer_network:
